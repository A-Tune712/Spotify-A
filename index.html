<script>
// ★設定
const CLIENT_ID = "9892d015f2734e85a98e291efff7396d";
const REDIRECT_URI = "https://a-tune712.github.io/Spotify--redirect/";
const SCOPES = "user-read-private user-read-email streaming user-modify-playback-state user-read-playback-state";

// PKCE: ランダム検証子とチャレンジを生成
function base64url(buf){return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
async function sha256(str){const enc=new TextEncoder().encode(str);const buf=await crypto.subtle.digest('SHA-256',enc);return base64url(buf);}
function randomString(n=64){const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';let s='';for(let i=0;i<n;i++) s+=chars[Math.floor(Math.random()*chars.length)];return s;}

document.getElementById("login").addEventListener("click", async () => {
  const verifier = randomString(64);
  const challenge = await sha256(verifier);
  // 後で交換に使う
  localStorage.setItem("spotify_pkce_verifier", verifier);

  const authUrl = "https://accounts.spotify.com/authorize"
    + "?client_id=" + encodeURIComponent(CLIENT_ID)
    + "&response_type=code"
    + "&redirect_uri=" + encodeURIComponent(REDIRECT_URI)
    + "&scope=" + encodeURIComponent(SCOPES)
    + "&code_challenge_method=S256"
    + "&code_challenge=" + encodeURIComponent(challenge)
    + "&show_dialog=true";

  location.href = authUrl;
});
</script>
